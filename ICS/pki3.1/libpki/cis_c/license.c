#ifdef WIN32
/* for windows networking...include Ws2_32.lib in windows project */
/* also must define IMPORT_CKM....-.-; */
#include "winsock2.h"
#pragma comment(lib, "ws2_32.lib")
#else
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netdb.h>
#endif /* WIN32 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "cert.h"
#include "base64.h"
#include "asn1.h"
#include "rsa.h"

#include "license.h"

int LICENSE_CheckKeyPair(const char *key_path, const char *cert_path)
{
	int ret;
	ASNBuf			*buf		        =	NULL;
	PKCryptPriKey 	*pMyPriKey	=	NULL;
	Certificate		*pMyCert	    =	NULL;

	buf = ASNBuf_NewFromFile( key_path );
	if (buf != NULL)
	{
		pMyPriKey = PrivateKey_Decode(buf, NID_rsaEncryption);
		if (pMyPriKey != NULL) 
		{	
			pMyCert = CERT_NewFromFile( cert_path );
			if (pMyCert != NULL)
			{
				if (CERT_CheckKeyPairPK(pMyCert, pMyPriKey, NULL) == SUCCESS)
				{
					ret = SUCCESS;
				}
        else
        {
          ret = ER_LICENSE_INVALID_KEYPAIR;
        }
			}
      else ret = ER_LICENSE_CANNOT_LOAD_CERT;
		}
    else ret = ER_LICENSE_CANNOT_DECODE_PRIKEY;
	}
  else ret = ER_LICENSE_CANNOT_LOAD_PRIKEY;

	ASNBuf_Del(buf);
	PKCRYPT_DelPriKey(pMyPriKey);
	ASN_Del(pMyCert);
	return ret;
}

int LICENSE_CheckCertificate( char *license_type,
                              const char *cert_path, const char *ver_str )
{
  ASNBuf		      licens_cert_str;
  Name		        *name;
  Certificate     *lcert	=NULL;
  Certificate     *lcacert=NULL;
  CERTS 		      *certs	=NULL;
  time_t 		      now;
  char 		        buf[1024], ip_str[256];
  char 		        buf1[1024];
  Nid			        nid;
  struct hostent  *host;
  int             ret ;
#ifdef WIN32
  WORD            wVersionRequested ;
  WSADATA         wsaData ;
#else
#endif

	ASNBuf_SetP(&licens_cert_str, LicenseRootCACertificateData, LicenseRootCACertificateLen);
	lcacert = ASN_New(Certificate, &licens_cert_str);
	if (lcacert)
	{
		certs = ASN_New(CERTS, NULL);
		CERTS_AddP(certs, lcacert);
		lcert = CERT_NewFromFile(cert_path);
		if (lcert)
		{
			name = lcert->tbsCertificate->subject;
			CERTS_AddP(certs, lcert);
    	time(&now);
      ret = CERTS_VerifyBasicInfo(certs, now) ;
			if( ret !=SUCCESS ) 
      {
        ASN_Del(certs);
        if( ret == ER_CERT_VALIDITY_EXPIRED || ret == ER_CERT_VALIDITY_NOT_STARTED )
          return ER_LICENSE_INVALID_VALIDITYPERIOD;
        else
          return ER_LICENSE_INVALID_CERTIFICATE ;
      }
			if (Name_Get(buf, 1024, &nid, name, 3, 0))
      {
        if(strcmp(buf, ver_str)) 
        {
          if (Name_Get(buf, 1024, &nid, name, 4, 0))
          {
            ASN_Del(certs);
            if(strcmp(buf, ver_str)) return ER_LICENSE_INVALID_VERIFYSTRING;
          }
          else 
          {
            ASN_Del(certs);
            return ER_LICENSE_INVALID_SUBJECTNAME;
          }
        }
      }
      else 
      {
        ASN_Del(certs);
        return ER_LICENSE_INVALID_SUBJECTNAME;
      }


#ifdef WIN32
        wVersionRequested = MAKEWORD( 2 , 0 ) ;
        WSAStartup( wVersionRequested , &wsaData ) ;
        if ( LOBYTE( wsaData.wVersion ) == 1 && HIBYTE( wsaData.wVersion ) == 0 )
          return ER_WINSOCK_VERSION_UNSUPPORTED ;

  			gethostname(ip_str, 1024);
  			host = gethostbyname(ip_str);
        for( i = 0 ; host->h_addr_list[i] != NULL ; i++ )
        {
  				sprintf(ip_str, "%hu.%hu.%hu.%hu",
						  (unsigned char)host->h_addr_list[i][0],
						  (unsigned char)host->h_addr_list[i][1],
						  (unsigned char)host->h_addr_list[i][2],
						  (unsigned char)host->h_addr_list[i][3]);
    			if(strcmp(buf, ip_str)==0)
          {
            break ;
          }  
        }
        WSACleanup() ;
        if(strcmp(buf, ip_str))
        {
          ASN_Del(certs);
          return ER_LICENSE_INVALID_HOST;
        }
#else
			gethostname(buf1, 1024);
			host = gethostbyname(buf1);
			if( host )
      {
  			sprintf(ip_str, "%hu.%hu.%hu.%hu",
					  (unsigned char)host->h_addr_list[0][0],
					  (unsigned char)host->h_addr_list[0][1],
					  (unsigned char)host->h_addr_list[0][2],
					  (unsigned char)host->h_addr_list[0][3]);
      }
			else
			{
				ip_str[0] = 0;
			}
      endhostent() ;
#endif

      if( Name_Get(buf, 1024, &nid, name, 5, 0))
      {
				if(strcmp(buf, ip_str)!=0)
				{
            return ER_LICENSE_INVALID_HOST;
         }
      }
      else 
      {
        ASN_Del(certs);
        return ER_LICENSE_INVALID_SUBJECTNAME;
      }
		}
    else 
    {
      ASN_Del(certs);
      return  ER_LICENSE_CANNOT_LOAD_CERT;
    }
	}
  else return ER_LICENSE_CANNOT_LOAD_ROOTCERT;

  if( license_type != NULL )
  {
    if( Name_Get( buf , 256, &nid, name, 4, 0 ) )
    {
      strcpy( license_type , buf ) ;
    }
  }
  ASN_Del(certs);

  return SUCCESS;
}

int  LicenseRootCACertificateLen =  998;

char LicenseRootCACertificateData[] = 
{(char)0x30,(char)0x82,(char)0x03,(char)0xE2,(char)0x30,(char)0x82,(char)0x02,(char)0xCA,(char)0xA0,(char)0x03,
(char)0x02,(char)0x01,(char)0x02,(char)0x02,(char)0x10,(char)0x3C,(char)0x3E,(char)0x9D,(char)0xEB,(char)0x01,
(char)0xDD,(char)0x12,(char)0x48,(char)0x9E,(char)0xA2,(char)0x27,(char)0x13,(char)0x26,(char)0xC1,(char)0x5A,
(char)0x86,(char)0x30,(char)0x0D,(char)0x06,(char)0x09,(char)0x2A,(char)0x86,(char)0x48,(char)0x86,(char)0xF7,
(char)0x0D,(char)0x01,(char)0x01,(char)0x05,(char)0x05,(char)0x00,(char)0x30,(char)0x81,(char)0x8A,(char)0x31,
(char)0x0B,(char)0x30,(char)0x09,(char)0x06,(char)0x03,(char)0x55,(char)0x04,(char)0x06,(char)0x13,(char)0x02,
(char)0x4B,(char)0x52,(char)0x31,(char)0x24,(char)0x30,(char)0x22,(char)0x06,(char)0x03,(char)0x55,(char)0x04,
(char)0x0A,(char)0x13,(char)0x1B,(char)0x50,(char)0x65,(char)0x6E,(char)0x74,(char)0x61,(char)0x20,(char)0x53,
(char)0x65,(char)0x63,(char)0x75,(char)0x72,(char)0x69,(char)0x74,(char)0x79,(char)0x20,(char)0x53,(char)0x79,
(char)0x73,(char)0x74,(char)0x65,(char)0x6D,(char)0x73,(char)0x20,(char)0x49,(char)0x6E,(char)0x63,(char)0x2E,
(char)0x31,(char)0x25,(char)0x30,(char)0x23,(char)0x06,(char)0x03,(char)0x55,(char)0x04,(char)0x0B,(char)0x13,
(char)0x1C,(char)0x49,(char)0x53,(char)0x53,(char)0x41,(char)0x43,(char)0x20,(char)0x41,(char)0x75,(char)0x74,
(char)0x68,(char)0x65,(char)0x6E,(char)0x74,(char)0x69,(char)0x63,(char)0x61,(char)0x74,(char)0x69,(char)0x6F,
(char)0x6E,(char)0x20,(char)0x53,(char)0x65,(char)0x72,(char)0x76,(char)0x69,(char)0x63,(char)0x65,(char)0x31,
(char)0x2E,(char)0x30,(char)0x2C,(char)0x06,(char)0x03,(char)0x55,(char)0x04,(char)0x03,(char)0x13,(char)0x25,
(char)0x50,(char)0x65,(char)0x6E,(char)0x74,(char)0x61,(char)0x20,(char)0x43,(char)0x65,(char)0x72,(char)0x74,
(char)0x69,(char)0x66,(char)0x69,(char)0x63,(char)0x61,(char)0x74,(char)0x65,(char)0x20,(char)0x41,(char)0x75,
(char)0x74,(char)0x68,(char)0x6F,(char)0x72,(char)0x69,(char)0x74,(char)0x79,(char)0x20,(char)0x2D,(char)0x20,
(char)0x50,(char)0x65,(char)0x6E,(char)0x74,(char)0x61,(char)0x43,(char)0x41,(char)0x30,(char)0x1E,(char)0x17,
(char)0x0D,(char)0x39,(char)0x39,(char)0x31,(char)0x32,(char)0x31,(char)0x32,(char)0x31,(char)0x35,(char)0x30,
(char)0x30,(char)0x30,(char)0x30,(char)0x5A,(char)0x17,(char)0x0D,(char)0x33,(char)0x37,(char)0x31,(char)0x32,
(char)0x33,(char)0x31,(char)0x31,(char)0x34,(char)0x35,(char)0x39,(char)0x35,(char)0x39,(char)0x5A,(char)0x30,
(char)0x81,(char)0x8A,(char)0x31,(char)0x0B,(char)0x30,(char)0x09,(char)0x06,(char)0x03,(char)0x55,(char)0x04,
(char)0x06,(char)0x13,(char)0x02,(char)0x4B,(char)0x52,(char)0x31,(char)0x24,(char)0x30,(char)0x22,(char)0x06,
(char)0x03,(char)0x55,(char)0x04,(char)0x0A,(char)0x13,(char)0x1B,(char)0x50,(char)0x65,(char)0x6E,(char)0x74,
(char)0x61,(char)0x20,(char)0x53,(char)0x65,(char)0x63,(char)0x75,(char)0x72,(char)0x69,(char)0x74,(char)0x79,
(char)0x20,(char)0x53,(char)0x79,(char)0x73,(char)0x74,(char)0x65,(char)0x6D,(char)0x73,(char)0x20,(char)0x49,
(char)0x6E,(char)0x63,(char)0x2E,(char)0x31,(char)0x25,(char)0x30,(char)0x23,(char)0x06,(char)0x03,(char)0x55,
(char)0x04,(char)0x0B,(char)0x13,(char)0x1C,(char)0x49,(char)0x53,(char)0x53,(char)0x41,(char)0x43,(char)0x20,
(char)0x41,(char)0x75,(char)0x74,(char)0x68,(char)0x65,(char)0x6E,(char)0x74,(char)0x69,(char)0x63,(char)0x61,
(char)0x74,(char)0x69,(char)0x6F,(char)0x6E,(char)0x20,(char)0x53,(char)0x65,(char)0x72,(char)0x76,(char)0x69,
(char)0x63,(char)0x65,(char)0x31,(char)0x2E,(char)0x30,(char)0x2C,(char)0x06,(char)0x03,(char)0x55,(char)0x04,
(char)0x03,(char)0x13,(char)0x25,(char)0x50,(char)0x65,(char)0x6E,(char)0x74,(char)0x61,(char)0x20,(char)0x43,
(char)0x65,(char)0x72,(char)0x74,(char)0x69,(char)0x66,(char)0x69,(char)0x63,(char)0x61,(char)0x74,(char)0x65,
(char)0x20,(char)0x41,(char)0x75,(char)0x74,(char)0x68,(char)0x6F,(char)0x72,(char)0x69,(char)0x74,(char)0x79,
(char)0x20,(char)0x2D,(char)0x20,(char)0x50,(char)0x65,(char)0x6E,(char)0x74,(char)0x61,(char)0x43,(char)0x41,
(char)0x30,(char)0x82,(char)0x01,(char)0x21,(char)0x30,(char)0x0D,(char)0x06,(char)0x09,(char)0x2A,(char)0x86,
(char)0x48,(char)0x86,(char)0xF7,(char)0x0D,(char)0x01,(char)0x01,(char)0x01,(char)0x05,(char)0x00,(char)0x03,
(char)0x82,(char)0x01,(char)0x0E,(char)0x00,(char)0x30,(char)0x82,(char)0x01,(char)0x09,(char)0x02,(char)0x82,
(char)0x01,(char)0x00,(char)0x5E,(char)0x76,(char)0x02,(char)0x48,(char)0x24,(char)0x78,(char)0xBE,(char)0x0A,
(char)0x2B,(char)0x45,(char)0x6A,(char)0x13,(char)0x87,(char)0xA7,(char)0x2C,(char)0x80,(char)0xE3,(char)0x89,
(char)0xD9,(char)0xB0,(char)0xEE,(char)0x70,(char)0xBE,(char)0xE0,(char)0x3E,(char)0x85,(char)0xAA,(char)0x29,
(char)0x84,(char)0xDD,(char)0xB3,(char)0x0B,(char)0x7E,(char)0x62,(char)0x1C,(char)0x81,(char)0xC4,(char)0x30,
(char)0xC7,(char)0x91,(char)0x22,(char)0x8A,(char)0x7F,(char)0x2A,(char)0xCC,(char)0x81,(char)0x12,(char)0x10,
(char)0x03,(char)0xCA,(char)0x26,(char)0x20,(char)0xAE,(char)0x18,(char)0x7E,(char)0x0C,(char)0xB8,(char)0xC2,
(char)0x15,(char)0xF0,(char)0x05,(char)0x33,(char)0xFE,(char)0x74,(char)0x64,(char)0x55,(char)0x62,(char)0x33,
(char)0x6E,(char)0x94,(char)0x95,(char)0xEE,(char)0x86,(char)0x03,(char)0x90,(char)0xFD,(char)0xDE,(char)0xD3,
(char)0xE4,(char)0xD9,(char)0x27,(char)0xA9,(char)0x9E,(char)0x26,(char)0x76,(char)0x10,(char)0x43,(char)0xEE,
(char)0x44,(char)0x0C,(char)0x42,(char)0x19,(char)0x4F,(char)0xF5,(char)0x69,(char)0x55,(char)0x83,(char)0x02,
(char)0xF1,(char)0xC4,(char)0xA0,(char)0x5B,(char)0x6B,(char)0xEE,(char)0x5D,(char)0x3D,(char)0x86,(char)0x54,
(char)0x73,(char)0xE3,(char)0x95,(char)0xB1,(char)0x5C,(char)0xA5,(char)0x13,(char)0x41,(char)0x31,(char)0xA3,
(char)0x20,(char)0x7C,(char)0xD1,(char)0x91,(char)0x0D,(char)0x26,(char)0xFD,(char)0x7C,(char)0x62,(char)0xE6,
(char)0xA9,(char)0x96,(char)0x68,(char)0x99,(char)0x05,(char)0xCF,(char)0x68,(char)0x48,(char)0x1D,(char)0xE6,
(char)0x58,(char)0xD1,(char)0x27,(char)0xC9,(char)0xE5,(char)0x8D,(char)0x04,(char)0x36,(char)0x19,(char)0xBA,
(char)0x48,(char)0x1B,(char)0x1D,(char)0x95,(char)0xF5,(char)0x03,(char)0xB4,(char)0xBC,(char)0xE6,(char)0xB3,
(char)0x01,(char)0xE2,(char)0xB3,(char)0xC2,(char)0xBD,(char)0x0A,(char)0xAA,(char)0x77,(char)0x6C,(char)0xA8,
(char)0x4F,(char)0x3E,(char)0xBE,(char)0xD9,(char)0xF1,(char)0xB1,(char)0x90,(char)0x01,(char)0xD6,(char)0x70,
(char)0x05,(char)0x8A,(char)0x93,(char)0x0B,(char)0xA2,(char)0x7C,(char)0x41,(char)0xE9,(char)0xC5,(char)0xC7,
(char)0x92,(char)0xF9,(char)0x65,(char)0x3B,(char)0x1A,(char)0x49,(char)0xE1,(char)0x26,(char)0x76,(char)0x25,
(char)0x9F,(char)0x70,(char)0x0F,(char)0xE1,(char)0x08,(char)0x03,(char)0x9A,(char)0x28,(char)0x48,(char)0x06,
(char)0xC8,(char)0x9F,(char)0x46,(char)0x60,(char)0x3D,(char)0x04,(char)0x6E,(char)0xA4,(char)0x5A,(char)0xE6,
(char)0xC7,(char)0x63,(char)0xBD,(char)0xB4,(char)0xB0,(char)0x89,(char)0x16,(char)0xFC,(char)0x60,(char)0xED,
(char)0x79,(char)0xE3,(char)0x84,(char)0x57,(char)0xA1,(char)0x36,(char)0x01,(char)0x65,(char)0x59,(char)0xA9,
(char)0xB6,(char)0x59,(char)0xD2,(char)0xDB,(char)0x9B,(char)0x58,(char)0x6D,(char)0x47,(char)0xD6,(char)0xCD,
(char)0x39,(char)0x41,(char)0x37,(char)0x07,(char)0x13,(char)0xF3,(char)0x14,(char)0x11,(char)0x02,(char)0x03,
(char)0x01,(char)0x00,(char)0x01,(char)0xA3,(char)0x43,(char)0x30,(char)0x41,(char)0x30,(char)0x0F,(char)0x06,
(char)0x03,(char)0x55,(char)0x1D,(char)0x13,(char)0x01,(char)0x01,(char)0xFF,(char)0x04,(char)0x05,(char)0x30,
(char)0x03,(char)0x01,(char)0x01,(char)0xFF,(char)0x30,(char)0x0F,(char)0x06,(char)0x03,(char)0x55,(char)0x1D,
(char)0x0F,(char)0x01,(char)0x01,(char)0xFF,(char)0x04,(char)0x05,(char)0x03,(char)0x03,(char)0x07,(char)0x06,
(char)0x00,(char)0x30,(char)0x1D,(char)0x06,(char)0x03,(char)0x55,(char)0x1D,(char)0x0E,(char)0x04,(char)0x16,
(char)0x04,(char)0x14,(char)0x9B,(char)0xDF,(char)0xF9,(char)0x18,(char)0x0B,(char)0x06,(char)0xC8,(char)0x10,
(char)0x30,(char)0x58,(char)0x51,(char)0x9D,(char)0xA9,(char)0x05,(char)0x9B,(char)0x33,(char)0xB2,(char)0xDC,
(char)0x47,(char)0x20,(char)0x30,(char)0x0D,(char)0x06,(char)0x09,(char)0x2A,(char)0x86,(char)0x48,(char)0x86,
(char)0xF7,(char)0x0D,(char)0x01,(char)0x01,(char)0x05,(char)0x05,(char)0x00,(char)0x03,(char)0x82,(char)0x01,
(char)0x01,(char)0x00,(char)0x32,(char)0x86,(char)0xD0,(char)0x65,(char)0xA9,(char)0x83,(char)0x15,(char)0x3C,
(char)0x22,(char)0x6A,(char)0xEF,(char)0x43,(char)0x40,(char)0xA9,(char)0xA5,(char)0xE2,(char)0xD8,(char)0x5A,
(char)0x23,(char)0x60,(char)0x78,(char)0x80,(char)0xF9,(char)0xBA,(char)0xC8,(char)0xE2,(char)0xEA,(char)0x59,
(char)0x90,(char)0x24,(char)0xC1,(char)0x55,(char)0x36,(char)0x10,(char)0x82,(char)0xF5,(char)0xE1,(char)0x49,
(char)0x49,(char)0xE6,(char)0x46,(char)0x1D,(char)0xE3,(char)0x81,(char)0x29,(char)0x55,(char)0x92,(char)0x3B,
(char)0x16,(char)0x91,(char)0xA6,(char)0xA4,(char)0x1A,(char)0x82,(char)0x12,(char)0x61,(char)0x80,(char)0x2A,
(char)0x54,(char)0x2B,(char)0x1A,(char)0x32,(char)0xFB,(char)0x11,(char)0xA4,(char)0x94,(char)0x79,(char)0xFC,
(char)0x4E,(char)0x3B,(char)0x7B,(char)0x1F,(char)0x46,(char)0x8A,(char)0x68,(char)0x79,(char)0x00,(char)0xB5,
(char)0x6C,(char)0x39,(char)0xAE,(char)0xFA,(char)0xA2,(char)0x7B,(char)0x48,(char)0x0B,(char)0xBC,(char)0xC0,
(char)0xAB,(char)0x22,(char)0xC5,(char)0x54,(char)0x4E,(char)0x67,(char)0xF2,(char)0x5C,(char)0x35,(char)0x03,
(char)0x50,(char)0xA1,(char)0x9B,(char)0xA9,(char)0xA1,(char)0xE5,(char)0xB5,(char)0x04,(char)0x42,(char)0x54,
(char)0xE7,(char)0xFA,(char)0xF1,(char)0x6D,(char)0x8E,(char)0x39,(char)0x73,(char)0xEC,(char)0x8E,(char)0x34,
(char)0xC9,(char)0x23,(char)0x4E,(char)0xE2,(char)0x90,(char)0xD6,(char)0xD3,(char)0xFD,(char)0x05,(char)0xE0,
(char)0xDE,(char)0x4F,(char)0x97,(char)0x25,(char)0x05,(char)0xC2,(char)0x1F,(char)0x36,(char)0x03,(char)0x94,
(char)0x8B,(char)0x20,(char)0xBA,(char)0x65,(char)0x14,(char)0xD7,(char)0x6F,(char)0x52,(char)0x37,(char)0x20,
(char)0xE1,(char)0x10,(char)0x6F,(char)0xD9,(char)0xB5,(char)0x91,(char)0xBE,(char)0x93,(char)0x03,(char)0x47,
(char)0x71,(char)0x29,(char)0xC1,(char)0xD3,(char)0x39,(char)0x1F,(char)0xF0,(char)0x5A,(char)0xB6,(char)0x2A,
(char)0x3F,(char)0x94,(char)0x91,(char)0xEC,(char)0x77,(char)0x07,(char)0xFA,(char)0x40,(char)0xB4,(char)0x79,
(char)0x43,(char)0xBB,(char)0x56,(char)0x93,(char)0x2D,(char)0xED,(char)0x94,(char)0x76,(char)0xD4,(char)0xE4,
(char)0x8D,(char)0xDF,(char)0x0E,(char)0x48,(char)0x39,(char)0x85,(char)0xB9,(char)0x69,(char)0x5F,(char)0xC3,
(char)0x33,(char)0x01,(char)0x08,(char)0x94,(char)0x9D,(char)0x48,(char)0x7E,(char)0x5B,(char)0x80,(char)0xF1,
(char)0xF0,(char)0x02,(char)0xC2,(char)0x75,(char)0x60,(char)0x12,(char)0x61,(char)0xA4,(char)0xCF,(char)0x56,
(char)0xC7,(char)0x3A,(char)0x88,(char)0xCE,(char)0x0D,(char)0xD3,(char)0x6A,(char)0xB3,(char)0x21,(char)0xD3,
(char)0x3F,(char)0xB3,(char)0xFD,(char)0x3A,(char)0x05,(char)0xCF,(char)0x01,(char)0xC9,(char)0x8D,(char)0x8D,
(char)0x37,(char)0x4E,(char)0x0C,(char)0xF0,(char)0x2B,(char)0x06,(char)0xFE,(char)0x95,(char)0xED,(char)0x0C,
(char)0xBC,(char)0x79,(char)0xC0,(char)0x74,(char)0x8A,(char)0x28,(char)0x94,(char)0x3D};

